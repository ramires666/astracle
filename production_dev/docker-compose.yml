version: "3.8"

services:
  # Backend API service.
  # Not exposed publicly; frontend container proxies /api requests to it.
  btc-astro-predictor:
    build:
      context: ..
      dockerfile: production_dev/Dockerfile
    container_name: btc-astro-backend
    expose:
      - "9742"
    environment:
      - PYTHONPATH=/app
      - PORT=9742
      - DATABASE_URL=${DATABASE_URL:-}
    volumes:
      - ../models_artifacts:/app/models_artifacts:ro
      - ../data/ephe:/app/data/ephe:ro
      - ../configs:/app/configs:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9742/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    labels:
      - "app.name=btc-astro-predictor-backend"
      - "app.description=Bitcoin Astrology Prediction API"
      - "app.version=1.0.0"

  # Frontend static files + reverse proxy to backend API.
  # This is the only public entrypoint.
  btc-astro-frontend:
    build:
      context: ..
      dockerfile: production_dev/frontend/Dockerfile
    container_name: btc-astro-frontend
    depends_on:
      btc-astro-predictor:
        condition: service_healthy
    ports:
      - "9742:80"
    restart: unless-stopped
    labels:
      - "app.name=btc-astro-predictor-frontend"
      - "app.description=Bitcoin Astrology Prediction UI"
      - "app.version=1.0.0"
